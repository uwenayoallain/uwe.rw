<div class="cursor-follower"></div>
<div class="cursor-dot"></div>

<script>
    import gsap from "gsap";

    document.addEventListener("astro:page-load", () => {
        const cursorDot = document.querySelector(".cursor-dot") as HTMLElement;
        const cursorFollower = document.querySelector(
            ".cursor-follower",
        ) as HTMLElement;
        const body = document.body;

        // Check preference - Default to DISABLED if not set
        const storedPref = localStorage.getItem("cursorEnabled");
        const isCursorEnabled = storedPref === "true"; // Defaults to false if null or "false"

        // Apply initial state
        if (!isCursorEnabled) {
            body.classList.add("custom-cursor-disabled");
        } else {
            body.classList.remove("custom-cursor-disabled");
        }

        // Toggle functionality - Button is now in Hero.astro
        const toggleBtn = document.getElementById("cursor-toggle");

        if (toggleBtn) {
            const label = toggleBtn.querySelector(".cursor-label");

            const updateLabel = (disabled: boolean) => {
                if (label) {
                    label.textContent = disabled
                        ? "Enable Cursor"
                        : "Disable Cursor";
                }
            };

            // Initial label state
            updateLabel(!isCursorEnabled);

            toggleBtn.addEventListener("click", () => {
                const isEnabled = !body.classList.contains(
                    "custom-cursor-disabled",
                );

                if (isEnabled) {
                    // Disable it
                    body.classList.add("custom-cursor-disabled");
                    localStorage.setItem("cursorEnabled", "false");
                    updateLabel(true);
                } else {
                    // Enable it
                    body.classList.remove("custom-cursor-disabled");
                    localStorage.setItem("cursorEnabled", "true");
                    updateLabel(false);
                }
            });
        }

        if (
            window.matchMedia("(pointer: fine)").matches &&
            cursorDot &&
            cursorFollower
        ) {
            gsap.set(cursorDot, { xPercent: -50, yPercent: -50, opacity: 0 });
            gsap.set(cursorFollower, {
                xPercent: -50,
                yPercent: -50,
                opacity: 0,
            });

            let isVisible = false;

            const onMouseMove = (e: MouseEvent) => {
                if (!isVisible) {
                    gsap.to([cursorDot, cursorFollower], {
                        opacity: 1,
                        duration: 0.3,
                    });
                    isVisible = true;
                }

                gsap.to(cursorDot, {
                    x: e.clientX,
                    y: e.clientY,
                    duration: 0.1,
                    ease: "power2.out",
                });

                gsap.to(cursorFollower, {
                    x: e.clientX,
                    y: e.clientY,
                    duration: 0.5,
                    ease: "power2.out",
                });
            };

            window.addEventListener("mousemove", onMouseMove);

            // Hover effects
            const interactiveElements = document.querySelectorAll(
                "a, button, .project-card, .blog-card, .blog-link",
            );

            interactiveElements.forEach((el) => {
                el.addEventListener("mouseenter", () => {
                    gsap.to(cursorFollower, {
                        scale: 2,
                        backgroundColor: "rgba(255, 255, 255, 1)",
                        border: "none",
                        duration: 0.3,
                    });
                    gsap.to(cursorDot, {
                        scale: 0,
                        duration: 0.3,
                    });
                });

                el.addEventListener("mouseleave", () => {
                    gsap.to(cursorFollower, {
                        scale: 1,
                        backgroundColor: "transparent",
                        border: "1px solid var(--color-text)",
                        duration: 0.3,
                    });
                    gsap.to(cursorDot, {
                        scale: 1,
                        duration: 0.3,
                    });
                });
            });
        }
    });
</script>

<style>
    .cursor-dot,
    .cursor-follower {
        position: fixed;
        top: 0;
        left: 0;
        border-radius: 50%;
        pointer-events: none;
        z-index: 9999;
        display: none;
    }

    @media (pointer: fine) {
        .cursor-dot,
        .cursor-follower {
            display: block;
        }

        /* Hide custom cursor when disabled */
        :global(body.custom-cursor-disabled) .cursor-dot,
        :global(body.custom-cursor-disabled) .cursor-follower {
            display: none !important;
        }

        /* Restore default cursor when disabled */
        :global(body.custom-cursor-disabled),
        :global(body.custom-cursor-disabled) a,
        :global(body.custom-cursor-disabled) button {
            cursor: auto !important;
        }
    }

    .cursor-dot {
        width: 8px;
        height: 8px;
        background-color: var(--color-text);
        mix-blend-mode: difference;
    }

    .cursor-follower {
        width: 40px;
        height: 40px;
        border: 1px solid var(--color-text);
        transition:
            transform 0.1s,
            width 0.3s,
            height 0.3s,
            background-color 0.3s;
        mix-blend-mode: difference;
    }
</style>

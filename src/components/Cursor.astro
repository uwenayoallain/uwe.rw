<div class='cursor-follower'></div>
<div class='cursor-dot'></div>

<button id='cursor-toggle' class='cursor-toggle' aria-label='Toggle Cursor'>
    <span class='cursor-label'>Disable Cursor</span>
    <svg
        xmlns='http://www.w3.org/2000/svg'
        width='24'
        height='24'
        viewBox='0 0 24 24'
        fill='none'
        stroke='currentColor'
        stroke-width='2'
        stroke-linecap='round'
        stroke-linejoin='round'
        class='cursor-icon'>
        <path
            d='M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z'
        ></path>
        <circle cx='12' cy='13' r='3'></circle>
    </svg>
</button>

<script>
    import gsap from "gsap";

    document.addEventListener("astro:page-load", () => {
        const cursorDot = document.querySelector(".cursor-dot") as HTMLElement;
        const cursorFollower = document.querySelector(
            ".cursor-follower",
        ) as HTMLElement;
        const toggleBtn = document.getElementById("cursor-toggle");
        const body = document.body;

        // Check preference
        const isCursorEnabled =
            localStorage.getItem("cursorEnabled") !== "false";
        if (!isCursorEnabled) {
            body.classList.add("custom-cursor-disabled");
        }

        // Toggle functionality
        if (toggleBtn) {
            const label = toggleBtn.querySelector(".cursor-label");

            const updateLabel = (disabled: boolean) => {
                if (label) {
                    label.textContent = disabled
                        ? "Enable Cursor"
                        : "Disable Cursor";
                }
            };

            // Initial label state
            updateLabel(isCursorEnabled === false);

            toggleBtn.addEventListener("click", () => {
                const isEnabled = !body.classList.contains(
                    "custom-cursor-disabled",
                );
                if (isEnabled) {
                    body.classList.add("custom-cursor-disabled");
                    localStorage.setItem("cursorEnabled", "false");
                    updateLabel(true);
                } else {
                    body.classList.remove("custom-cursor-disabled");
                    localStorage.setItem("cursorEnabled", "true");
                    updateLabel(false);
                }
            });
        }

        if (
            window.matchMedia("(pointer: fine)").matches &&
            cursorDot &&
            cursorFollower
        ) {
            gsap.set(cursorDot, { xPercent: -50, yPercent: -50, opacity: 0 });
            gsap.set(cursorFollower, {
                xPercent: -50,
                yPercent: -50,
                opacity: 0,
            });

            let isVisible = false;

            const onMouseMove = (e: MouseEvent) => {
                if (!isVisible) {
                    gsap.to([cursorDot, cursorFollower], {
                        opacity: 1,
                        duration: 0.3,
                    });
                    isVisible = true;
                }

                gsap.to(cursorDot, {
                    x: e.clientX,
                    y: e.clientY,
                    duration: 0.1,
                    ease: "power2.out",
                });

                gsap.to(cursorFollower, {
                    x: e.clientX,
                    y: e.clientY,
                    duration: 0.5,
                    ease: "power2.out",
                });
            };

            window.addEventListener("mousemove", onMouseMove);

            // Hover effects
            const interactiveElements = document.querySelectorAll(
                "a, button, .project-card, .blog-card, .blog-link",
            );

            interactiveElements.forEach((el) => {
                el.addEventListener("mouseenter", () => {
                    gsap.to(cursorFollower, {
                        scale: 2,
                        backgroundColor: "rgba(255, 255, 255, 1)",
                        border: "none",
                        duration: 0.3,
                    });
                    gsap.to(cursorDot, {
                        scale: 0,
                        duration: 0.3,
                    });
                });

                el.addEventListener("mouseleave", () => {
                    gsap.to(cursorFollower, {
                        scale: 1,
                        backgroundColor: "transparent",
                        border: "1px solid var(--color-text)",
                        duration: 0.3,
                    });
                    gsap.to(cursorDot, {
                        scale: 1,
                        duration: 0.3,
                    });
                });
            });
        }
    });
</script>

<style>
    .cursor-dot,
    .cursor-follower {
        position: fixed;
        top: 0;
        left: 0;
        border-radius: 50%;
        pointer-events: none;
        z-index: 9999;
        display: none;
    }

    @media (pointer: fine) {
        .cursor-dot,
        .cursor-follower {
            display: block;
        }

        /* Hide custom cursor when disabled */
        :global(body.custom-cursor-disabled) .cursor-dot,
        :global(body.custom-cursor-disabled) .cursor-follower {
            display: none !important;
        }

        /* Restore default cursor when disabled */
        :global(body.custom-cursor-disabled),
        :global(body.custom-cursor-disabled) a,
        :global(body.custom-cursor-disabled) button {
            cursor: auto !important;
        }
    }

    .cursor-dot {
        width: 8px;
        height: 8px;
        background-color: var(--color-text);
        mix-blend-mode: difference;
    }

    .cursor-follower {
        width: 40px;
        height: 40px;
        border: 1px solid var(--color-text);
        transition:
            transform 0.1s,
            width 0.3s,
            height 0.3s,
            background-color 0.3s;
        mix-blend-mode: difference;
    }

    /* Toggle Button */
    .cursor-toggle {
        position: fixed;
        bottom: var(--space-lg);
        left: var(--space-lg);
        z-index: 100;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid var(--color-border);
        color: var(--color-text-muted);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .cursor-toggle:hover {
        background: var(--color-text);
        color: var(--color-bg);
        transform: scale(1.1);
    }

    :global(body.custom-cursor-disabled) .cursor-toggle {
        opacity: 0.5;
    }

    :global(body.custom-cursor-disabled) .cursor-toggle:hover {
        opacity: 1;
    }

    .cursor-label {
        position: absolute;
        left: 100%;
        top: 50%;
        transform: translateY(-50%) translateX(15px);
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 1;
        pointer-events: none;
        border: 1px solid var(--color-border);
        color: var(--color-text);
    }
</style>
